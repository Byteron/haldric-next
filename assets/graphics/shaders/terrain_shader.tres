[gd_resource type="Shader" format=3 uid="uid://cmio24vwc8bxt"]

[resource]
code = "shader_type spatial;

uniform sampler2DArray textures : hint_albedo;
uniform sampler2D cell_texture : hint_albedo;

uniform vec2 texel_size;

varying vec3 terrain;
varying vec3 visibility;


vec4 get_cell_data(vec3 uvw, int index)
{
	vec2 uv;
	
	if (index == 0)
	{
		uv.x = (uvw.x + 0.5) * texel_size.x;
	}
	else if (index == 1)
	{
		uv.x = (uvw.y + 0.5) * texel_size.x;
	}
	else
	{
		uv.x = (uvw.z + 0.5) * texel_size.x;
	}
	
	float row = floor(uv.x);
	uv.x -= row;
	uv.y = (row + 0.5) * texel_size.y;
	
	vec4 data = texture(cell_texture, uv);
	data.g *= 255f;
	return data;
}

vec4 get_terrain_color(vec4 color, vec2 position, int i)
{	
	if (i == 0)
	{
		vec3 uvw = vec3(position.xy * 0.02, terrain[0]);
		vec4 c = texture(textures, uvw);
		return c * color.r * visibility.x;
	}
	else if (i == 1)
	{
		vec3 uvw = vec3(position.xy * 0.02, terrain[1]);
		vec4 c = texture(textures, uvw);
		return c * color.g * visibility.y;
	}
	else
	{
		vec3 uvw = vec3(position.xy * 0.02, terrain[2]);
		vec4 c = texture(textures, uvw);
		return c * color.b * visibility.z;
	}
}

void vertex()
{
	vec3 uvw = vec3(UV, UV2.y);
	vec4 cell0 = get_cell_data(uvw, 0);
	vec4 cell1 = get_cell_data(uvw, 1);
	vec4 cell2 = get_cell_data(uvw, 2);
	
	terrain.x = cell0.g;
	terrain.y = cell1.g;
	terrain.z = cell2.g;
	
	visibility.x = cell0.a;
	visibility.y = cell1.a;
	visibility.z = cell2.a;
	
	visibility = mix(vec3(0.25), vec3(1f), visibility);
}

void fragment()
{
	vec2 pos = ((CAMERA_MATRIX) * vec4(VERTEX, 1f)).xz;
	
	vec4 c = get_terrain_color(COLOR, pos, 0) + get_terrain_color(COLOR, pos, 1) + get_terrain_color(COLOR, pos, 2);
	ALBEDO = c.rgb;
}"
